<!DOCTYPE html>
<html>
<head>
  <title>8-Puzzle Algorithm</title>
  <link rel="stylesheet" type="text/css" href="assets/css/style.css">
</head>
<body>
<header>
  <h1 style="text-align: center;">8-Puzzle</h1>
  <button id="mix">Misturar</button><input type="text" name="moves" id="moves"><br>
  <button id="bfs">Brute-force (Width Search)</button>
  <button id="astar">A* (1 heuristica)</button>
  <button id="case1">Caso 1</button>
  <br> Número de movimentos <div class="moves">0</div>
</header>
<div class="board">
  <ul>
    <li id="sq-0" class="square">1</li>
    <li id="sq-1" class="square">2</li>
    <li id="sq-2" class="square">3</li>
    <li id="sq-3" class="square">4</li>
    <li id="sq-4" class="square">5</li>
    <li id="sq-5" class="square">6</li>
    <li id="sq-6" class="square">7</li>
    <li id="sq-7" class="square">8</li>
    <li id="sq-8" class="square">0</li>
  </ul>
</div>
<div class="step"></div>
<script type="text/javascript" src="assets/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript">
// var stack = [];
// stack.push(2);       // stack is now [2]
// stack.push(5);       // stack is now [2, 5]
// var i = stack.pop(); // stack is now [2]
// alert(i);            // displays 5

// var queue = [];
// queue.push(2);         // queue is now [2]
// queue.push(5);         // queue is now [2, 5]
// var i = queue.shift(); // queue is now [5]
// alert(i);              // displays 2
// o que em cada posição o vazio pode trocar
  var pos = [];
  pos[0] = [3, 1];
  pos[1] = [4, 0, 2];
  pos[2] = [5, 1];
  pos[3] = [0, 6, 4];
  pos[4] = [1, 7, 3, 5];
  pos[5] = [2, 8, 4];
  pos[6] = [3, 7];
  pos[7] = [4, 6, 8];
  pos[8] = [5, 7];

  $(document).ready(function() {
    $(".square").on("click", function(){
      var elem = $(this),
      cur_elem = elem.attr('id').split("-");
      cur_elem = cur_elem[1];
      cur_elem_id = '#sq-' + cur_elem,
      freeElem = getFreeNode(pos[cur_elem]);

      if(freeElem){
        swap(cur_elem_id, freeElem);
        var result = verify_result();
        if(result){
          alert('resolvido!');
        }
      }
    });

    $("#mix").click(function(){
      var i = $("#moves").val();
      if(i === ''){
        i = 50;
      }
      mix(i);
    });
  });

  function getFreeNode(element){
    for (var i = element.length - 1; i >= 0; i--) {
      var neighbor = element[i],
          neighbor_id = '#sq-' + neighbor;

      if ($(neighbor_id).text() == '0') {
        return neighbor_id;
      }
    }
  }

  function swap(currentElem, freeElem){
    var auxCurrent = $(currentElem).text();
    $(currentElem).text($(freeElem).text());
    $(freeElem).text(auxCurrent);
    var mov = parseInt($('.moves').text()) + 1;
    $('.moves').text(mov.toString());
  }

  function mix(moves){
    var m = 0, i = randomElem();

    while(m < moves){
      var freeElem = getFreeNode(pos[i]);
      if (freeElem) {
        swap("#sq-" + i, freeElem);
        m++;
      } else {
        i = randomElem();
      }
    }
  }

  function randomElem(){
    return Math.floor((Math.random()*9));
  }

  function verify_result(){
    var result = 0;
    for(var i = 0; i<8; i++){
      if($('#sq-'+ i).text() == (i+1).toString()){
        result++;
      }
    }

    if($('#sq-8').text() == '0') result++;

    if(result == 9){
      return true;
    } else {
      return false;
    }
  }

  function showState(state){
    for(var i=0; i<state.length; i++){
      var id_state = '#sq-'+i;
      $(id_state).text(state[i]);
    }
  }

  function State(state, dad = null, depth = 0){
    this.goal = [1,2,3,4,5,6,7,8,0];
    this.state = state;
    this.dad = dad;
    this.depth = depth;

    this.isGoal = function(){
      for(var i=0; i<this.state.length; i++){
        if(this.state[i] != this.goal[i]) return false;
      }
      return true;
    }

    this.getDad = function(){
      return this.dad;
    }

    this.getDepth = function(){
      return this.depth;
    }

    this.getStateArray = function(){
      var array = [];
      for(var i=0; i<this.state.length; i++){
        array.push(this.state[i]);
      }
      return array;
    }

    this.whereisZero = function(){
      for(var i=0; i<this.state.length; i++){
        if(this.state[i] == 0){
          return i;
        }
      }
    }

    this.compareState = function(state2){
      for(var i=0; i<this.state.length; i++){
        if(this.state[i] != state2[i]) return false;
      }
      return true;
    }

    this.existInArray = function(array){
      for(var i=0; i<array.length; i++){
        if(array[i].compareState(this.state)){
          return i;
        }
      }
      return null;
    }

    this.swap = function(i, j){
      var aux = this.state[i];
      this.state[i] = this.state[j];
      this.state[j] = aux;
    }

    this.getChildren = function(){
      return pos[this.whereisZero()];
    }

    this.cost = function(){
      var count = 0;
      for(var i=0; i<this.state.length; i++){
        if(this.state[i] != 0 && this.state[i] != this.goal[i]){
          count++;
        }
      }

      return count;
    }

  }

  function QueuePriority(){
    this.queue = [];

    this.push = function(state){
      var i = 0;

      while (i < this.queue.length && parseInt(state.cost()) > parseInt(this.queue[i].cost()))
        i++;
      if (i >= this.queue.length)
        this.queue.push(state);   // insere no fim
      else
        this.queue.splice(i,0,state); // insere na posição i
    }

    this.empty = function(){
      if(this.queue.length == 0) return true;
      else return false;
    }

    this.pop = function(){
      return this.queue.pop();
    }

    this.shift = function(){
      return this.queue.shift();
    }

    this.getQueue = function(){
      return this.queue;
    }

    this.splice = function(x, y){
      this.queue.splice(x, y);
    }
  }

  function bfs(puzzle){
    
    var initial_state = new State(puzzle);
    var queue = [];
    var path = [];
    var depth = initial_state.getDepth();
    var state;
    queue.push(initial_state);

    while(queue.length)
    {
      state = queue.shift();
      depth = state.getDepth();
      if(state.isGoal()){
        var aux = state;
        while(aux.getDad() != null){
          path.push(aux.getStateArray());
          aux = aux.getDad();
        }
        //console.log(path);
        return path;
      }else{
        console.log(depth);
        if (depth < 30){
          depth++;
          var children = pos[state.whereisZero()];
          for(var i=0; i<children.length; i++){
            var original_array = state.getStateArray();
            var child = new State(original_array, state, depth);
            child.swap(child.whereisZero(), children[i]);
            queue.push(child);
          }
        }
      }
    }
  }

  $('#bfs').click(function(){
    var initial = [];
    for(var i=0; i<9; i++){
      initial[i] = parseInt($('#sq-'+i).text());
    }
    var path = bfs(initial);
    var step = $('<button/>',
     {
         text: 'Step',
         click: function () {       
          if(path.length){
            var element = path.pop();
            showState(element);
          }else{
            $('.step').html('');
          }
        }
     });

    $('.step').html(step);
    
  });

  $('#case1').click(function(){
    var case1 = [7,1,3,2,6,0,5,4,8];
    for(var i=0; i<case1.length; i++){
      $('#sq-'+i).text(case1[i]);
    }
  }); 

  function astar(puzzle){
    
    var initial_state = new State(puzzle);
    var queue = new QueuePriority();
    var path = [];
    var visited = [];
    var depth = initial_state.getDepth();
    var state;
    queue.push(initial_state);

    while(!queue.empty())
    {
      state = queue.shift();
      depth = state.getDepth();
      visited.push(state);
      if(state.isGoal()){
        var aux = state;
        while(aux.getDad() != null){
          path.push(aux.getStateArray());
          aux = aux.getDad();
        }
        return path;
      }else{
        if (depth < 30){
          depth++;
          var children = pos[state.whereisZero()];
          for(var i=0; i<children.length; i++){
            var original_array = state.getStateArray();
            var child = new State(original_array, state, depth);
            child.swap(child.whereisZero(), children[i]);

            var exist = child.existInArray(visited);
            if(exist != null) continue; // se já existe continua

            var index_exist = child.existInArray(queue);
            if(index_exist != null){
              if (queue[index_exist].cost() <= child.cost())
                continue;
              else
                queue.splice(index_exist,1);  // remove o nodo antigo da lista
            }

            queue.push(child);
          }
        }
      }
    }
  }


  $('#astar').click(function(){
    var initial = [];
    for(var i=0; i<9; i++){
      initial[i] = parseInt($('#sq-'+i).text());
    }
    var path = astar(initial);
    console.log(path);
    var step = $('<button/>',
     {
         text: 'Step',
         click: function () {       
          if(path.length){
            var element = path.pop();
            showState(element);
          }else{
            $('.step').html('');
          }
        }
     });

    $('.step').html(step);
    
  });

  

</script>
</body>
</html>